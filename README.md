<!-- DOCSIBLE START -->

# 📃 Role overview

## debian_common_tasks Ansible role

Ansible role to configure Debian based systems common settings and additional disks, compatible with Raspberry Pi Os with a dedicated task

To do:

- Better README and documentation
- Integration tests
- Gihub release workflows

Contribution, issues and pull requests are welcome.

### Defaults

**These are static variables with lower priority**

#### File: defaults/main.yml

| Var                                                                                                                                                | Type | Value                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         | Required | Title                                                                               |
| -------------------------------------------------------------------------------------------------------------------------------------------------- | ---- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------- | ----------------------------------------------------------------------------------- |
| [ansible_ssh_user](https://github.com/gianmarco-mameli/ansible_debian_common_tasks/blob/main/defaults/main.yml#L7)                                 | str  | `{{ ansible_user }}`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          | true     | Ansible SSH user                                                                    |
| [admin_password](https://github.com/gianmarco-mameli/ansible_debian_common_tasks/blob/main/defaults/main.yml#L12)                                  | str  | `{{ ansible_password }}`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      | false    | Ansible SSH user password                                                           |
| [ssh_key](https://github.com/gianmarco-mameli/ansible_debian_common_tasks/blob/main/defaults/main.yml#L17)                                         | str  | ``                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            | false    | Ansible SSH user ssh key                                                            |
| [additional_disk](https://github.com/gianmarco-mameli/ansible_debian_common_tasks/blob/main/defaults/main.yml#L30)                                 | list | `[]`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          | false    | Additional disks partition and mount                                                |
| [debian_common_tasks_set_password](https://github.com/gianmarco-mameli/ansible_debian_common_tasks/blob/main/defaults/main.yml#L34)                | bool | `True`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        | false    | Set user password                                                                   |
| [debian_common_tasks_set_ssh_key](https://github.com/gianmarco-mameli/ansible_debian_common_tasks/blob/main/defaults/main.yml#L38)                 | bool | `True`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        | false    | Set user ssh key                                                                    |
| [debian_common_tasks_ssh_key_users](https://github.com/gianmarco-mameli/ansible_debian_common_tasks/blob/main/defaults/main.yml#L42)               | list | `['{{ ansible_ssh_user }}']`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | false    | Add ssh key to this users list                                                      |
| [debian_common_tasks_configure_sudo](https://github.com/gianmarco-mameli/ansible_debian_common_tasks/blob/main/defaults/main.yml#L47)              | bool | `True`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        | false    | Configure sudo                                                                      |
| [debian_common_tasks_sudoers](https://github.com/gianmarco-mameli/ansible_debian_common_tasks/blob/main/defaults/main.yml#L51)                     | list | `['{{ ansible_ssh_user }}']`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | false    | Sudoers list                                                                        |
| [debian_common_tasks_sudo_commands](https://github.com/gianmarco-mameli/ansible_debian_common_tasks/blob/main/defaults/main.yml#L56)               | list | `['ALL']`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     | false    | Sudoers commands                                                                    |
| [debian_common_tasks_disable_root_login](https://github.com/gianmarco-mameli/ansible_debian_common_tasks/blob/main/defaults/main.yml#L61)          | bool | `True`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        | false    | Disable root login                                                                  |
| [debian_common_tasks_remove_users](https://github.com/gianmarco-mameli/ansible_debian_common_tasks/blob/main/defaults/main.yml#L65)                | list | `[]`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          | false    | Users to remove                                                                     |
| [debian_common_tasks_remove_users_paths](https://github.com/gianmarco-mameli/ansible_debian_common_tasks/blob/main/defaults/main.yml#L69)          | list | `[]`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          | false    | Paths of users leftovers to remove                                                  |
| [debian_common_tasks_force_filesystem](https://github.com/gianmarco-mameli/ansible_debian_common_tasks/blob/main/defaults/main.yml#L73)            | bool | `False`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       | false    | When create the filesystems on the additional disks, force the formatting           |
| [debian_common_tasks_partition_temp_mount](https://github.com/gianmarco-mameli/ansible_debian_common_tasks/blob/main/defaults/main.yml#L77)        | str  | `/mnt`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        | false    | After the filesystem creation, mount the partition to temporary mount for file sync |
| [debian_common_tasks_raspberry_usb_power](https://github.com/gianmarco-mameli/ansible_debian_common_tasks/blob/main/defaults/main.yml#L81)         | bool | `False`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       | false    | Enable usb_max_current_enable flag on Raspberry Pi                                  |
| [debian_common_tasks_disable_armhf](https://github.com/gianmarco-mameli/ansible_debian_common_tasks/blob/main/defaults/main.yml#L85)               | bool | `True`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        | false    | Disable armhf architecture on arm64                                                 |
| [debian_common_tasks_apt_cacher](https://github.com/gianmarco-mameli/ansible_debian_common_tasks/blob/main/defaults/main.yml#L89)                  | bool | `False`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       | false    | Configure aptcacher                                                                 |
| [debian_common_tasks_apt_cacher_config](https://github.com/gianmarco-mameli/ansible_debian_common_tasks/blob/main/defaults/main.yml#L93)           | str  | `/etc/apt/apt.conf.d/00aptproxy`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              | false    | Aptcacher config file path                                                          |
| [debian_common_tasks_apt_cacher_url](https://github.com/gianmarco-mameli/ansible_debian_common_tasks/blob/main/defaults/main.yml#L97)              | str  | ``                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            | false    | Aptcacher URL                                                                       |
| [debian_common_tasks_gpg_keyrings](https://github.com/gianmarco-mameli/ansible_debian_common_tasks/blob/main/defaults/main.yml#L101)               | list | `['gpg', 'debian-archive-keyring', 'debian-keyring', 'debian-ports-archive-keyring', 'python3-debian']`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       | false    | GPG and various keyrings packages                                                   |
| [debian_common_tasks_custom_keys](https://github.com/gianmarco-mameli/ansible_debian_common_tasks/blob/main/defaults/main.yml#L115)                | list | `[]`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          | false    | Add custom apt key by id from a keyserver, see full description                     |
| [debian_common_tasks_custom_ca](https://github.com/gianmarco-mameli/ansible_debian_common_tasks/blob/main/defaults/main.yml#L119)                  | bool | `False`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       | false    | Add custom CA certificate                                                           |
| [debian_common_tasks_ca_certificate_secret](https://github.com/gianmarco-mameli/ansible_debian_common_tasks/blob/main/defaults/main.yml#L123)      | str  | ``                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            | false    | Custom CA certificate content secret                                                |
| [debian_common_tasks_custom_repos](https://github.com/gianmarco-mameli/ansible_debian_common_tasks/blob/main/defaults/main.yml#L135)               | list | `[]`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          | false    | Custom apt deb repositories to add, see full description                            |
| [debian_common_tasks_apt_upgrade](https://github.com/gianmarco-mameli/ansible_debian_common_tasks/blob/main/defaults/main.yml#L139)                | bool | `True`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        | false    | Enable apt upgrade                                                                  |
| [debian_common_tasks_apt_upgrade_type](https://github.com/gianmarco-mameli/ansible_debian_common_tasks/blob/main/defaults/main.yml#L149)           | str  | `full`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        | false    | Apt upgrade type, see full description                                              |
| [debian_common_tasks_common_packages](https://github.com/gianmarco-mameli/ansible_debian_common_tasks/blob/main/defaults/main.yml#L153)            | list | `[]`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          | false    | Apt packages to install                                                             |
| [debian_common_tasks_pipx_packages](https://github.com/gianmarco-mameli/ansible_debian_common_tasks/blob/main/defaults/main.yml#L157)              | list | `[]`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          | false    | Pipx packages to install                                                            |
| [debian_common_tasks_remove_packages](https://github.com/gianmarco-mameli/ansible_debian_common_tasks/blob/main/defaults/main.yml#L161)            | list | `[]`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          | false    | Apt packages to remove                                                              |
| [debian_common_tasks_scripts_dir_create](https://github.com/gianmarco-mameli/ansible_debian_common_tasks/blob/main/defaults/main.yml#L168)         | bool | `True`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        | false    | Create custom scripts directory                                                     |
| [debian_common_tasks_scripts_dir](https://github.com/gianmarco-mameli/ansible_debian_common_tasks/blob/main/defaults/main.yml#L172)                | str  | `/opt/scripts`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                | false    | Custom scripts directory                                                            |
| [debian_common_tasks_systemd_conf_lines](https://github.com/gianmarco-mameli/ansible_debian_common_tasks/blob/main/defaults/main.yml#L182)         | list | `[]`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          | false    | Lines to add or modify in the systemd conf file, see full description               |
| [debian_common_tasks_systemd_hdmi_on](https://github.com/gianmarco-mameli/ansible_debian_common_tasks/blob/main/defaults/main.yml#L186)            | bool | `True`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        | false    | Enable hdmi output                                                                  |
| [debian_common_tasks_locale](https://github.com/gianmarco-mameli/ansible_debian_common_tasks/blob/main/defaults/main.yml#L190)                     | str  | `en_GB.UTF-8`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | false    | Locale to set                                                                       |
| [debian_common_tasks_timezone](https://github.com/gianmarco-mameli/ansible_debian_common_tasks/blob/main/defaults/main.yml#L194)                   | str  | `Europe/Rome`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | false    | Timezone to set                                                                     |
| [debian_common_tasks_boot_to_cli](https://github.com/gianmarco-mameli/ansible_debian_common_tasks/blob/main/defaults/main.yml#L198)                | bool | `True`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        | false    | Boot to CLI                                                                         |
| [debian_common_tasks_boot_login](https://github.com/gianmarco-mameli/ansible_debian_common_tasks/blob/main/defaults/main.yml#L202)                 | bool | `False`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       | false    | Boot auto login                                                                     |
| [debian_common_tasks_boot_net_install_ui_always](https://github.com/gianmarco-mameli/ansible_debian_common_tasks/blob/main/defaults/main.yml#L206) | bool | `False`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       | false    | Boot always to network install UI                                                   |
| [debian_common_tasks_new_config_txt](https://github.com/gianmarco-mameli/ansible_debian_common_tasks/blob/main/defaults/main.yml#L210)             | str  | `/boot/firmware/config.txt`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | false    | New config.txt path                                                                 |
| [debian_common_tasks_old_config_txt](https://github.com/gianmarco-mameli/ansible_debian_common_tasks/blob/main/defaults/main.yml#L214)             | str  | `/boot/config.txt`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            | false    | Old config.txt path                                                                 |
| [debian_common_tasks_config_txt](https://github.com/gianmarco-mameli/ansible_debian_common_tasks/blob/main/defaults/main.yml#L218)                 | str  | `{{ debian_common_tasks_new_config_txt if ansible_distribution_major_version ¦ int >= 12 else debian_common_tasks_old_config_txt }}`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          | false    | Config.txt path set by debian version                                               |
| [debian_common_tasks_audio_state](https://github.com/gianmarco-mameli/ansible_debian_common_tasks/blob/main/defaults/main.yml#L223)                | str  | `off`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         | false    | Raspberry audio state on/off                                                        |
| [debian_common_tasks_camera_state](https://github.com/gianmarco-mameli/ansible_debian_common_tasks/blob/main/defaults/main.yml#L227)               | int  | `0`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | false    | Raspberry camera state 0/1                                                          |
| [debian_common_tasks_display_state](https://github.com/gianmarco-mameli/ansible_debian_common_tasks/blob/main/defaults/main.yml#L231)              | int  | `0`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | false    | Raspberry display state 0/1                                                         |
| [debian_common_tasks_poe_fan](https://github.com/gianmarco-mameli/ansible_debian_common_tasks/blob/main/defaults/main.yml#L235)                    | int  | `0`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | false    | Raspberry poe fan state 0/1                                                         |
| [debian_common_tasks_i2c_state](https://github.com/gianmarco-mameli/ansible_debian_common_tasks/blob/main/defaults/main.yml#L239)                  | str  | `off`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         | false    | Raspberry i2c state on/off                                                          |
| [debian_common_tasks_spi_state](https://github.com/gianmarco-mameli/ansible_debian_common_tasks/blob/main/defaults/main.yml#L243)                  | str  | `off`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         | false    | Raspberry spi state on/off                                                          |
| [debian_common_tasks_otg_mode](https://github.com/gianmarco-mameli/ansible_debian_common_tasks/blob/main/defaults/main.yml#L247)                   | int  | `0`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | false    | Raspberry otg mode state 0/1                                                        |
| [debian_common_tasks_enable_composite](https://github.com/gianmarco-mameli/ansible_debian_common_tasks/blob/main/defaults/main.yml#L251)           | bool | `False`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       | false    | Raspberry composite state                                                           |
| [debian_common_tasks_enable_pciex_gen3](https://github.com/gianmarco-mameli/ansible_debian_common_tasks/blob/main/defaults/main.yml#L255)          | bool | `False`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       | false    | Raspberry pciex gen3 state                                                          |
| [debian_common_tasks_sdtv_mode](https://github.com/gianmarco-mameli/ansible_debian_common_tasks/blob/main/defaults/main.yml#L265)                  | str  | `pal`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         | false    | Raspberry sdtv mode, see full description                                           |
| [debian_common_tasks_gpu_mem](https://github.com/gianmarco-mameli/ansible_debian_common_tasks/blob/main/defaults/main.yml#L272)                    | str  | `{{ (ansible_memtotal_mb / 4 ¦ int) if (debian_common_tasks_camera_state == 1 or not debian_common_tasks_boot_to_cli ¦ bool) else 16 }}`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      | false    | Raspberry gpu mem, see full description                                             |
| [debian_common_tasks_config_txt_lines](https://github.com/gianmarco-mameli/ansible_debian_common_tasks/blob/main/defaults/main.yml#L282)           | list | `[{'regexp': 'disable_splash=', 'line': 'disable_splash=1'}, {'regexp': 'dtparam=audio=', 'line': 'dtparam=audio={{ debian_common_tasks_audio_state }}'}, {'regexp': 'camera_auto_detect=', 'line': 'camera_auto_detect={{ debian_common_tasks_camera_state }}'}, {'regexp': 'display_auto_detect=', 'line': 'display_auto_detect={{ debian_common_tasks_display_state }}'}, {'regexp': 'gpu_mem=', 'line': 'gpu_mem={{ debian_common_tasks_gpu_mem }}'}, {'regexp': 'disable_poe_fan=', 'line': 'disable_poe_fan={{ debian_common_tasks_poe_fan }}'}, {'regexp': 'dtparam=i2c_arm=', 'line': 'dtparam=i2c_arm={{ debian_common_tasks_i2c_state }}'}, {'regexp': 'dtparam=spi=', 'line': 'dtparam=spi={{ debian_common_tasks_spi_state }}'}, {'regexp': 'otg_mode=', 'line': 'otg_mode={{ debian_common_tasks_otg_mode }}'}, {'regexp': '#?dtparam=pciex1_gen=3', 'line': '{{ "" if debian_common_tasks_enable_pciex_gen3 else "#" }}dtparam=pciex1_gen=3'}]` | false    | Raspberry config.txt lines to add or modify, see full description                   |
| [debian_common_tasks_cgroups_enable](https://github.com/gianmarco-mameli/ansible_debian_common_tasks/blob/main/defaults/main.yml#L317)             | bool | `True`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        | false    | Enable cgroups on Raspberry Pi                                                      |
| [debian_common_tasks_cgroups_cmdlines](https://github.com/gianmarco-mameli/ansible_debian_common_tasks/blob/main/defaults/main.yml#L321)           | list | `['cgroup_enable=cpuset', 'cgroup_memory=1', 'cgroup_enable=memory']`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         | false    | Cgroups cmdlines                                                                    |
| [debian_common_tasks_rpiconnect_enable](https://github.com/gianmarco-mameli/ansible_debian_common_tasks/blob/main/defaults/main.yml#L328)          | bool | `False`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       | false    | Rpiconnect service install and enable                                               |
| [debian_common_tasks_rpiconnect_lingering](https://github.com/gianmarco-mameli/ansible_debian_common_tasks/blob/main/defaults/main.yml#L332)       | bool | `False`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       | false    | Rpiconnect user lingering                                                           |

<details>
<summary><b>🖇️ Full descriptions for vars in defaults/main.yml</b></summary>
<br>
<b>ansible_ssh_user:</b> Ansible SSH user to use and configure
<br>
<b>admin_password:</b> Ansible SSH user password to use and configure, required if true `debian_common_tasks_set_password`
<br>
<b>ssh_key:</b> Ansible SSH user ssh key to use and configure, required if true `debian_common_tasks_set_ssh_key`
<br>
<b>additional_disk:</b> Additional disks partition and mount, must be a list of dicts with the following keys:<br>
- device: The device to partition and mount, e.g. /dev/sda or /dev/disk/by-path/xxxYYYYzzzz-www<br>
- number: The partition number to create, e.g. 1<br>
- fs_type: The filesystem type to use, e.g. ext4 (optional)<br>
- mount_point: The mount point to use, e.g. /mnt/data (optional)<br>
- mount: Whether to mount the partition or not, e.g. true (optional)<br>
- size: The size of the partition to create, e.g. 10% or 10G<br>
<br>
<b>debian_common_tasks_custom_keys:</b> Add custom apt key by id from a keyserver<br>
Must be a list of dicts with the following keys:<br>
- keyserver: The keyserver to use<br>
- id: The key id<br>
<br>
<b>debian_common_tasks_custom_repos:</b> Custom apt deb repositories to add<br>
Must be a list of dicts with the following keys:<br>
- uris: The repository URL<br>
- suites: The repository suite<br>
- components: The repository components<br>
- signed_by: The keyring to use (optional)<br>
- architectures: The architectures to use (optional)<br>
<br>
<b>debian_common_tasks_apt_upgrade_type:</b> Apt upgrade type<br>
- full: full upgrade<br>
- safe: safe upgrade<br>
- dist: dist upgrade<br>
- yes: normal upgrade<br>
<br>
<b>debian_common_tasks_systemd_conf_lines:</b> Lines to add or modify in the systemd conf file<br>
Must be a list of dicts with the following keys:<br>
- regexp: The regex to match the line<br>
- line: The line to add or modify<br>
- state: The state of the line (present or absent) (default: present)<br>
<br>
<b>debian_common_tasks_sdtv_mode:</b> Raspberry sdtv mode, must be one of:<br>
- 'ntsc' Normal NTSC<br>
- 'japan_ntsc' Japanese version of NTSC – no pedestal<br>
- 'pal' Normal PAL<br>
- 'braz_pal' Brazilian version of PAL – 525/60 rather than 625/50, different subcarrier<br>
<br>
<b>debian_common_tasks_gpu_mem:</b> Raspberry gpu mem, default config is 1/4 of total memory<br>
if camera is enabled or 16mb if camera is disabled<br>
<br>
<b>debian_common_tasks_config_txt_lines:</b> Raspberry config.txt lines to add or modify, must be a list of dicts with the following keys:<br>
- regexp: The regex to match the line<br>
- line: The line to add or modify<br>
- state: The state of the line (present or absent) (default: present)<br>
<br>
<br>
</details>

### Vars

**These are variables with higher priority**

#### File: vars/main.yml

| Var                                                                                                                             | Type | Value                                                   | Required | Title |
| ------------------------------------------------------------------------------------------------------------------------------- | ---- | ------------------------------------------------------- | -------- | ----- |
| [debian_common_tasks_ca_certs_path](https://github.com/gianmarco-mameli/ansible_debian_common_tasks/blob/main/vars/main.yml#L5) | str  | `/usr/local/share/ca-certificates`                      | n/a      | n/a   |
| [debian_common_tasks_systemd_conf](https://github.com/gianmarco-mameli/ansible_debian_common_tasks/blob/main/vars/main.yml#L8)  | str  | `/etc/systemd/system.conf`                              | n/a      | n/a   |
| [debian_common_tasks_sshd_config](https://github.com/gianmarco-mameli/ansible_debian_common_tasks/blob/main/vars/main.yml#L11)  | str  | `/etc/ssh/sshd_config`                                  | n/a      | n/a   |
| [debian_common_tasks_sdtv_map](https://github.com/gianmarco-mameli/ansible_debian_common_tasks/blob/main/vars/main.yml#L14)     | dict | `{'ntsc': 0, 'japan_ntsc': 1, 'pal': 2, 'braz_pal': 3}` | n/a      | n/a   |
| [debian_common_tasks_cmdline_file](https://github.com/gianmarco-mameli/ansible_debian_common_tasks/blob/main/vars/main.yml#L21) | str  | `/boot/firmware/cmdline.txt`                            | n/a      | n/a   |

<details>
<summary><b>🖇️ Full Descriptions for vars in vars/main.yml</b></summary>
<br>
<b>debian_common_tasks_ca_certs_path:</b> CA certificates path
<br>
<b>debian_common_tasks_systemd_conf:</b> systemd conf file path
<br>
<b>debian_common_tasks_sshd_config:</b> sshd config file path
<br>
<b>debian_common_tasks_sdtv_map:</b> sdtv settings map
<br>
<b>debian_common_tasks_cmdline_file:</b> Cmdline file path
<br>
<br>
</details>

### Tasks

#### File: tasks/access_permissions.yml

| Name                                             | Module                       | Has Conditions |
| ------------------------------------------------ | ---------------------------- | -------------- |
| access_permissions ¦ Assert variables            | ansible.builtin.assert       | False          |
| access_permissions ¦ Configure sudo              | block                        | True           |
| access_permissions ¦ Install sudo                | ansible.builtin.apt          | False          |
| access_permissions ¦ Add ansible user to sudoers | community.general.sudoers    | False          |
| access_permissions ¦ Set ssh access via key      | ansible.posix.authorized_key | True           |
| access_permissions ¦ Change ssh user password    | ansible.builtin.shell        | True           |
| access_permissions ¦ Disable root login          | ansible.builtin.user         | True           |
| access_permissions ¦ Remove users                | ansible.builtin.user         | False          |
| access_permissions ¦ Remove users leftovers      | ansible.builtin.file         | False          |

#### File: tasks/additional_disk.yml

| Name                                                                                  | Module                       | Has Conditions |
| ------------------------------------------------------------------------------------- | ---------------------------- | -------------- |
| additional_disk ¦ Partition and mount additional disks                                | block                        | True           |
| additional_disk ¦ Set usb_max_current_enable if disk is usb connected to Raspberry Pi | block                        | True           |
| additional_disk ¦ Set usb_max_current_enable if disk is usb connected to Raspberry Pi | ansible.builtin.lineinfile   | False          |
| additional_disk ¦ Flush handlers                                                      | ansible.builtin.meta         | False          |
| additional_disk ¦ Install packages                                                    | ansible.builtin.apt          | False          |
| additional_disk ¦ Get real devices path                                               | ansible.builtin.stat         | False          |
| additional_disk ¦ Set real devices path                                               | ansible.builtin.set_fact     | False          |
| additional_disk ¦ Create partitions                                                   | community.general.parted     | False          |
| additional_disk ¦ Create filesystems                                                  | community.general.filesystem | True           |
| additional_disk ¦ Regather devices facts                                              | ansible.builtin.setup        | False          |
| additional_disk ¦ Add partition name and uuids to partitions                          | ansible.builtin.set_fact     | False          |
| additional_disk ¦ Mount partitions                                                    | ansible.posix.mount          | True           |
| additional_disk ¦ Set not existing mounts                                             | ansible.builtin.set_fact     | True           |
| additional_disk ¦ Check if needed to move folders on additional disk                  | block                        | True           |
| additional_disk ¦ Check mount points                                                  | ansible.builtin.stat         | False          |
| additional_disk ¦ Set folders to sync and to create                                   | ansible.builtin.set_fact     | False          |
| additional_disk ¦ Sync existing paths                                                 | block                        | True           |
| additional_disk ¦ Create temp Path                                                    | ansible.builtin.file         | False          |
| additional_disk ¦ Mount volume to temp path                                           | ansible.posix.mount          | False          |
| additional_disk ¦ Synchronize folders                                                 | ansible.posix.synchronize    | False          |
| additional_disk ¦ Create new paths                                                    | block                        | True           |
| additional_disk ¦ Create path                                                         | ansible.builtin.file         | False          |
| additional_disk ¦ Mount volumes to paths                                              | ansible.posix.mount          | False          |
| additional_disk ¦ Delete temp Path                                                    | ansible.builtin.file         | False          |

#### File: tasks/check_reboot.yml

| Name                                      | Module                 | Has Conditions |
| ----------------------------------------- | ---------------------- | -------------- |
| check_reboot ¦ Check if reboot is pending | ansible.builtin.stat   | False          |
| check_reboot ¦ Reboot                     | ansible.builtin.reboot | True           |

#### File: tasks/common.yml

| Name                                                | Module                            | Has Conditions |
| --------------------------------------------------- | --------------------------------- | -------------- |
| common ¦ Disable architecture armhf on arm64        | ansible.builtin.command           | True           |
| common ¦ Configure aptcacher                        | ansible.builtin.template          | True           |
| common ¦ Install gpg and keyrings                   | ansible.builtin.apt               | False          |
| common ¦ Add custom apts key by id from a keyserver | ansible.builtin.apt_key           | True           |
| common ¦ Install custom ca certificate              | block                             | True           |
| common ¦ Install ca certificate                     | ansible.builtin.copy              | False          |
| common ¦ Update ca certificates                     | ansible.builtin.command           | False          |
| common ¦ Add custom package repositories            | ansible.builtin.deb822_repository | False          |
| common ¦ Apt-get upgrade                            | ansible.builtin.apt               | True           |
| common ¦ Install common packages                    | ansible.builtin.apt               | False          |
| common ¦ Install pipx packages                      | community.general.pipx            | True           |
| Remove packages from variable remove_packages       | ansible.builtin.apt               | True           |
| common ¦ Create custom scripts directory            | ansible.builtin.file              | True           |
| common ¦ Configure sshd                             | ansible.builtin.lineinfile        | False          |
| common ¦ Configure systemd config file              | ansible.builtin.lineinfile        | True           |

#### File: tasks/common_raspberry.yml

| Name                                                      | Module                     | Has Conditions |
| --------------------------------------------------------- | -------------------------- | -------------- |
| common_raspberry ¦ Change system locale                   | ansible.builtin.command    | False          |
| common_raspberry ¦ Change timezone                        | ansible.builtin.command    | False          |
| common_raspberry ¦ Set boot type                          | ansible.builtin.command    | False          |
| common_raspberry ¦ Set boot network install ui            | ansible.builtin.command    | False          |
| common_raspberry ¦ Turn off hdmi with rc.local            | ansible.builtin.lineinfile | False          |
| common_raspberry ¦ Set config.txt parameters              | ansible.builtin.lineinfile | False          |
| common_raspberry ¦ Disable display backlight service      | ansible.builtin.service    | False          |
| common_raspberry ¦ Enable composite out and set sdtv_mode | ansible.builtin.lineinfile | True           |
| common_raspberry ¦ Config cgroups                         | block                      | True           |
| common_raspberry ¦ Check if cmdline file exists           | ansible.builtin.stat       | False          |
| common_raspberry ¦ Disable ipv6 on cmdline                | block                      | True           |
| common_raspberry ¦ Get actual cmdline file                | ansible.builtin.slurp      | False          |
| common_raspberry ¦ Update cmdline file for cgroups        | ansible.builtin.lineinfile | True           |
| common_raspberry ¦ Configure rpi-connect service          | block                      | True           |
| common_raspberry ¦ Install rpi-connect service            | ansible.builtin.package    | False          |
| common_raspberry ¦ Enable lingering                       | ansible.builtin.command    | True           |
| common_raspberry ¦ Enable rpi-connect service             | ansible.builtin.command    | False          |

## Playbook

```yml
---
- name: Configure access and permissions and additional disks
  hosts: all
  become: true
  become_method: ansible.builtin.sudo
  gather_facts: true
  any_errors_fatal: true

  vars:
    ansible_ssh_user: test_user
    admin_password: test_password
    ssh_key: test_ssh_key
    additional_disk:
      - device: /dev/sdb
        number: 1
        fs_type: ext4
        mount_point: /mnt/data
        mount: true
        size: 10G

  tasks:
    - name: Include vars dir
      ansible.builtin.include_vars:
        dir: vars
        ignore_unknown_extensions: true

    - name: Configure access and permissions
      ansible.builtin.include_role:
        name: debian_common_tasks
        tasks_from: access_permissions

    - name: Partition additional disk
      ansible.builtin.include_role:
        name: debian_common_tasks
        tasks_from: additional_disk

    - name: Check if reboot is needed and reboot
      ansible.builtin.include_role:
        name: debian_common_tasks
        tasks_from: check_reboot
```

## Author Information

gianmarco-mameli

#### License

MIT

#### Minimum Ansible Version

2.1

#### Platforms

No platforms specified.

<!-- DOCSIBLE END -->
